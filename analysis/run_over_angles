#!/usr/bin/python3.5

import subprocess
import os
import numpy as np

import tqdm

import sys

from fncs.fnc_calc_angle import calculateBulkAngle
from fncs.plotResultsFile import plotResults

def generateAutoRunFile(theta_in_deg, phi_in_deg, n_particles, energy_in_keV):

    theta = np.deg2rad(theta_in_deg)
    phi = np.deg2rad(phi_in_deg)

    # Calculate the particle starting position such that hit is in center of window
    y_offset = -5 # cm
    z_pos = abs(y_offset) * np.tan(theta)
    x_pos = abs(y_offset) * np.tan(phi)

    position_string = str(x_pos) + ' ' + str(y_offset) + ' ' + str(z_pos)

    # Calculate initial momentum direction for particle
    y_dir = 1
    z_dir = y_dir * np.tan(theta)
    x_dir = y_dir * np.tan(phi)

    dir_string = str(x_dir) + ' ' + str(y_dir) + ' ' + str(z_dir)

    with open('../macros/auto_run_file.mac', 'w') as f:
        f.write('/run/initialize \n')
        f.write('/control/verbose 0 \n')
        f.write('/run/verbose 0 \n')
        f.write('/event/verbose 0 \n')
        f.write('/tracking/verbose 0 \n')

        f.write('/gps/particle e- \n')
        f.write('/gps/energy ' + str(energy_in_keV) + ' keV \n')
        f.write('/gps/position ' + position_string  + ' \n')
        f.write('/gps/direction ' + dir_string + ' \n')
        f.write('/gps/pos/type Point \n')

        f.write('/run/beamOn ' + str(n_particles) + ' \n')

def executeAutoRunFile():
    bashCommand = "../build/main ../macros/auto_run_file.mac"
    process = subprocess.Popen(bashCommand.split(), stdout = subprocess.PIPE)
    output, error = process.communicate()

    if error is not None:
        exception("Error in simulation")

    if output is None:
        exception("Error in simulation: no output")

def cleanDataDirectory():
    if len(os.listdir('./data')) > 1:
        bashCleanCommand = 'rm ./data/det1_hits.csv ./data/det2_hits.csv ./data/init_pos.csv'
        process = subprocess.Popen(bashCleanCommand.split(), stdout=subprocess.PIPE)
    else:
        return

def writeHeaderLine():
    with open('./data/results.txt', 'w') as f:
        f.write('Number_Particles,Theta_actual,Phi_actual,Theta_est,Phi_est,'+
                'Theta_std,Phi_std\n')

def frange(start, stop, step):  # Modified range to iterate over floats (i.e. 10.5 degrees, etc.)
     i = start
     while i < stop:
         yield i
         i += step

def main():

    # Energy passed in from command line
    try:
        energy = sys.argv[1]
    except IndexError:
        print('Please enter energy in keV: ')
        energy = input()

    #####################################
    ####### Edit these parameters #######
    #####################################

    angle_resolution = 1
    min_angle = -20.
    max_angle = 20.

    numberOfParticles = 10000

    #####################################
    ####### ^^^^^^^^^^^^^^^^^^^^^ #######
    #####################################

    # Overwrites whatever results.txt file was already in directory
    writeHeaderLine()

    with tqdm.tqdm(total=100, unit_scale=True) as pbar:
        for angle in frange(min_angle, max_angle, angle_resolution):

            pbar.set_postfix(angle=angle, refresh=True)

            # Generates auto run file given the parameters we wish to simulate over
            generateAutoRunFile(theta_in_deg=angle,
                                phi_in_deg=0,
                                n_particles=numberOfParticles,
                                energy_in_keV=energy)

            # Removes any raw hit files that were already in data directory
            cleanDataDirectory()

            # Runs simulation with autogenerated run file, outputs raw hit results into data directory
            executeAutoRunFile()

            # Processes raw hit data into statistical estimates, appends to results.txt
            calculateBulkAngle()

            # Progress bar update
            pbar.update((max_angle-min_angle)/angle_resolution)

    # Plots results.txt and saves file to electron_detector/results directory
    plotResults(energy)


if __name__=='__main__':
    main()
